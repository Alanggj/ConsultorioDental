<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalle de Expediente - Sonrisa Perfecta</title>
    
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f7f6; /* Un gris muy claro */
        }

        /* La "hoja" principal que simula el documento */
        .expediente-hoja {
            max-width: 850px; /* Tamaño similar a A4 */
            margin: 2rem auto;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            overflow: hidden; /* Para que el header y footer se ajusten */
            position: relative; /* Para el watermark */
        }

        /* 1. Encabezado (Inspirado en el recetario azul) */
        .expediente-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem;
            background: linear-gradient(135deg, #eaf4ff 0%, #ffffff 70%);
            border-bottom: 2px solid #0d6efd; /* Línea azul */
        }
        .expediente-header .doctor-info h2 {
            color: #0d6efd;
            font-weight: 700;
            margin-bottom: 0;
        }
        .expediente-header .doctor-info p {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: #555;
        }
        .expediente-header .logo-area i {
            font-size: 3.5rem;
            color: #0d6efd;
        }

        /* 2. Cuerpo del formulario */
        .expediente-body {
            padding: 2.5rem;
            position: relative; /* Para el watermark */
            z-index: 10;
        }

        /* Watermark (Logo de fondo) */
        .watermark {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18rem; /* Tamaño gigante */
            color: #0d6efd;
            opacity: 0.06; /* Muy transparente */
            z-index: 1;
        }

        /* Estilo de los campos para que parezcan líneas */
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        .input-line {
            border: 0;
            border-bottom: 1px solid #ccc;
            border-radius: 0;
            padding-left: 0;
            background-color: transparent;
        }
        .input-line:focus {
            box-shadow: none;
            border-bottom-color: #0d6efd;
            background-color: #fafdff;
        }
        textarea.input-line {
            height: 120px;
            border: 1px solid #ccc; /* Textarea se ve mejor con borde completo */
            border-radius: 4px;
            padding: 0.5rem;
        }
        textarea.input-line:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
        }
        
        /* 3. Área de Firma (al final del cuerpo) */
        .firma-area {
            margin-top: 5rem;
            text-align: right;
        }
        .firma-linea {
            width: 280px;
            border-top: 1px solid #555;
            margin-left: auto;
            padding-top: 0.5rem;
        }
        .firma-area label {
            font-size: 0.9rem;
            color: #333;
            font-weight: 600;
        }

        /* 4. Pie de página (Inspirado en el recetario) */
        .expediente-footer {
            background-color: #0d6efd;
            color: white;
            padding: 1.5rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        .expediente-footer p {
            margin-bottom: 0.25rem;
        }
        .expediente-footer i {
            margin-right: 0.5rem;
        }

        /* 5. Botones de acción (Fuera de la hoja) */
        .botones-accion {
            text-align: center;
            padding: 1.5rem 0 3rem 0;
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                Sonrisa Perfecta
                <strong class="d-block">Consultorio Dental</strong>
            </a>
            <a href="admin-expedientes.html" class="btn btn-outline-primary">
                <i class="bi-arrow-left"></i> Volver a Recetas
            </a>
        </div>
    </nav>

    <div class="container">

        <form id="form-expediente" class="expediente-hoja">
            
            <div class="expediente-header">
                <div class="doctor-info">
                    <h2>Dr. Javier Morales</h2>
                    <p>DENTISTA</p>
                    <p>Céd. Prof. 12345678</p>
                </div>
                <div class="logo-area">
                    <i class="bi bi-heart-pulse-fill"></i>
                </div>
            </div>

            <div class="expediente-body">
                
                <div class="watermark"><i class="bi bi-heart-pulse-fill"></i></div>

                <div class="row mb-4">
                    <div class="col-md-7">
                        <label for="nombre" class="form-label">Nombre del Paciente:</label>
                        <input type="text" id="nombre" class="form-control input-line" placeholder="Nombre completo...">
                    </div>
                    <div class="col-md-2">
                        <label for="edad" class="form-label">Edad:</label>
                        <input type="text" id="edad" class="form-control input-line" placeholder="Ej: 35">
                    </div>
                    <div class="col-md-3">
                        <label for="fecha" class="form-label">Fecha:</label>
                        <input type="date" id="fecha" class="form-control input-line" value="">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="alergias" class="form-label">Medicamentos que es Alérgico/a:</label>
                    <textarea id="alergias" class="form-control input-line" rows="3" 
                        placeholder="Ej: Penicilina, Ibuprofeno..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="tratamiento" class="form-label">Tratamiento:</label>
                    <textarea id="tratamiento" class="form-control input-line" rows="6" 
                        placeholder="Describir el tratamiento realizado..."></textarea>
                </div>

                <div class="firma-area">
                    <div class="firma-linea"></div>
                    <label>Firma del Doctor</label>
                </div>

            </div>
            
            <div class="expediente-footer">
                <div>
                    <p><i class="bi bi-geo-alt-fill"></i> Av. Salud Dental #123, Aguascalientes</p>
                    <p><i class="bi bi-telephone-fill"></i> 55 47 79 94 15</p>
                </div>
                <div>
                    <p><i class="bi bi-envelope-fill"></i> sonrisa@consultorio.com</p>
                    <p><i class="bi bi-globe"></i> www.sonrisaperfecta.com</p>
                </div>
            </div>
        </form>

        <div class="botones-accion">
            <button type="submit" form="form-expediente" class="btn btn-primary btn-lg me-2">
                <i class="bi-save-fill"></i> Guardar Cambios
            </button>
            <button type="button" class="btn btn-secondary btn-lg" id="btn-descargar-pdf">
                <i class="bi-download"></i> Descargar PDF
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            
            // --- Simulación de Carga de Datos ---
            // 1. Obtener el ID del paciente de la URL
            const params = new URLSearchParams(window.location.search);
            const pacienteId = params.get('id');

            // 2. Poner la fecha de hoy por defecto
            document.getElementById('fecha').valueAsDate = new Date();

            // 3. Si hay un ID, cargar los datos (simulación)
            if (pacienteId && pacienteId === '1') { // Si es Carlos Méndez
                document.getElementById('nombre').value = "Carlos Méndez";
                document.getElementById('edad').value = "35";
                document.getElementById('fecha').value = "2025-01-22";
                document.getElementById('alergias').value = "Ninguna conocida.";
                document.getElementById('tratamiento').value = "Paciente con historial de bruxismo nocturno severo, desgaste dental generalizado, sensibilidad en piezas posteriores y cefaleas matutinas. Evaluación clínica revela hipertrofia de músculos maseteros y signos de estrés articular. Se confeccionó férula de descarga rígida superior.";
            } else if (pacienteId && pacienteId === '2') { // Si es Ana García
                document.getElementById('nombre').value = "Ana García";
                document.getElementById('edad').value = "28";
                document.getElementById('fecha').value = "2024-11-15";
                document.getElementById('alergias').value = "Penicilina";
                document.getElementById('tratamiento').value = "Revisión y limpieza dental. Se detectó caries incipiente en molar 26. Se programa cita para resina.";
            }
            // Si no hay ID, los campos (excepto la fecha) aparecerán vacíos para un nuevo expediente.

            // --- Lógica para Guardar ---
            document.getElementById('form-expediente').addEventListener('submit', function(e) {
                e.preventDefault();
                const datos = {
                    id: pacienteId,
                    nombre: document.getElementById('nombre').value,
                    edad: document.getElementById('edad').value,
                    fecha: document.getElementById('fecha').value,
                    alergias: document.getElementById('alergias').value,
                    tratamiento: document.getElementById('tratamiento').value
                };
                
                // AQUÍ HARÍAS EL FETCH (PUT o POST) a tu backend
                alert('¡Datos guardados! (Simulación)\n' + JSON.stringify(datos, null, 2));
                // window.location.href = 'admin-expedientes.html'; // Descomentar para redirigir
            });

            // --- Lógica para Descargar PDF ---
            document.getElementById('btn-descargar-pdf').addEventListener('click', function () {
                alert('Iniciando descarga de PDF... esto puede tardar un segundo.');
                
                const { jsPDF } = window.jspdf;
                const hoja = document.getElementById('form-expediente');
                
                html2canvas(hoja, { scale: 2 /* Mejora la resolución */ }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' = portrait, 'mm', 'a4'
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);

                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    const imgY = 0; // Empezar desde arriba
                    
                    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                    
                    // Nombre del archivo
                    const nombrePaciente = document.getElementById('nombre').value || 'expediente';
                    pdf.save(`Expediente-${nombrePaciente}.pdf`);
                });
            });

        });
    </script>

</body>
</html>