<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalle de Expediente - Sonrisa Perfecta</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-icons.css" rel="stylesheet">
    <link href="css/templatemo-medic-care.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <style>
        /* Estilos para que parezca una hoja */
        .expediente-hoja {
            max-width: 800px;
            margin: 2rem auto;
            padding: 3rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .expediente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .expediente-header img {
            max-width: 100px;
            border-radius: 50%;
        }
        .expediente-header .doctor-info {
            text-align: right;
            color: #333;
        }
        .expediente-footer {
            text-align: center;
            font-size: 0.8rem;
            color: #777;
            border-top: 1px solid #eee;
            padding-top: 1rem;
            margin-top: 2rem;
        }
        /* Estilo para alertas médicas en el expediente */
        .alerta-medica {
            background-color: #fff5f5;
            border-left: 4px solid #dc3545;
            padding: 10px 15px;
            border-radius: 4px;
        }
        .aviso-cronico {
            background-color: #f8f9fa;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                Sonrisa Perfecta
                <strong class="d-block">Panel Médico</strong>
            </a>
            <a href="admin-citas.html" class="btn btn-outline-primary">
                <i class="bi-arrow-left"></i> Volver a Citas
            </a>
        </div>
    </nav>

    <div class="container">
        <form id="form-expediente" class="expediente-hoja">
            
            <div class="expediente-header">
                <img src="images/gallery/logo.png" alt="Logo Dr. Morales"> 
                <div class="doctor-info">
                    <h3 class="mb-1" id="header-doctor">DR. JAVIER MORALES</h3> 
                    <p class="mb-0">DENTISTA</p> 
                    <p class="mb-0">Céd. Prof. <span id="header-cedula">...</span></p> 
                </div>
            </div>

            <h4 class="text-center mb-4">EXPEDIENTE CLÍNICO</h4> 
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="nombre" class="form-label fw-bold">Nombre:</label>
                    <input type="text" id="nombre" class="form-control" readonly> 
                </div>

                <div class="col-md-3">
                    <label for="edad" class="form-label fw-bold">Edad:</label>
                    <input type="text" id="edad" class="form-control" readonly> 
                </div> 
                <div class="col-md-3">
                    <label for="fecha-visita" class="form-label fw-bold">Fecha última visita:</label>
                    <input type="date" id="fecha-visita" class="form-control" readonly> 
                </div>
            </div>

            <div id="box-alergias" class="mb-3 d-none">
                <div class="alerta-medica">
                    <label class="form-label fw-bold text-danger mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i> ALERGIAS:
                    </label>
                    <input type="text" id="alergias" class="form-control-plaintext fw-bold text-danger" readonly>
                </div>
            </div>

            <div id="box-enfermedades" class="mb-3 d-none">
                <div class="aviso-cronico">
                    <label class="form-label fw-bold text-dark mb-0">
                        <i class="bi bi-activity"></i> Enfermedades Crónicas / Antecedentes:
                    </label>
                    <input type="text" id="enfermedades" class="form-control-plaintext text-dark" readonly>
                </div>
            </div>

            <hr>

            <div class="mb-3">
                <label for="diagnostico" class="form-label h5">Diagnóstico:</label> 
                <textarea id="diagnostico" class="form-control" rows="5" placeholder="Ingrese el diagnóstico..."></textarea>
            </div>

            <div class="mb-3">
                <label for="tratamiento" class="form-label h5">Tratamiento:</label> 
                <textarea id="tratamiento" class="form-control" rows="5" placeholder="Ingrese el tratamiento..."></textarea>
            </div>
            
            <div class="text-end mt-4">
                <button type="button" class="btn btn-danger me-2" id="btn-eliminar">
                    <i class="bi-trash"></i> Eliminar Expediente
                </button>
                <button type="button" class="btn btn-secondary me-2" id="btn-descargar-pdf">
                    <i class="bi-download"></i> Descargar PDF
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi-save-fill"></i> Guardar Cambios
                </button>
            </div>

            <div class="expediente-footer">
                Este documento es confidencial y forma parte del historial clínico. 
            </div>

        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const params = new URLSearchParams(window.location.search);
            const usuarioId = params.get('id');

            if (!usuarioId) {
                Swal.fire('Error', 'No se especificó un paciente');
                window.location.href = 'admin-expedientes.html';
                return;
            }

            // CARGAR DATOS
            fetch(`/api/expediente/${usuarioId}`)
                .then(res => res.json())
                .then(response => {
                    if (!response.success) throw new Error(response.message);
                
                    const data = response.data;
                    
                    // Llenar campos básicos
                    document.getElementById('nombre').value = data.nombre_completo;
                    document.getElementById('edad').value = data.edad + " años";
                    document.getElementById('fecha-visita').value = data.ultima_visita || new Date().toISOString().split('T')[0];
                
                    // --- LÓGICA PARA MOSTRAR CAMPOS CONDICIONALES ---
                    
                    // 1. Alergias
                    if (data.alergias && data.alergias.trim() !== "") {
                        document.getElementById('box-alergias').classList.remove('d-none');
                        document.getElementById('alergias').value = data.alergias;
                    }

                    // 2. Enfermedades Crónicas
                    if (data.enfermedades_cronicas && data.enfermedades_cronicas.trim() !== "") {
                        document.getElementById('box-enfermedades').classList.remove('d-none');
                        document.getElementById('enfermedades').value = data.enfermedades_cronicas;
                    }
                    // -----------------------------------------------

                    // Datos doctor
                    if (data.doctor_nombre) {
                        document.getElementById('header-doctor').textContent = "DR. " + data.doctor_nombre.toUpperCase();
                        document.getElementById('header-cedula').textContent = data.cedula_profesional || 'SIN CÉDULA';
                    } else {
                        document.getElementById('header-doctor').textContent = "DR. GENERAL";
                        document.getElementById('header-cedula').textContent = "PENDIENTE";
                    }
                    
                    document.getElementById('diagnostico').value = data.diagnostico || '';
                    document.getElementById('tratamiento').value = data.tratamiento || '';
                })
                .catch(err => {
                    console.error(err);
                    Swal.fire('Error', 'Error al cargar datos del expediente: ' + err.message, 'error');
                });

            // GUARDAR CAMBIOS
            document.getElementById('form-expediente').addEventListener('submit', function(e) {
                e.preventDefault();
            
                const datos = {
                    usuario_id: usuarioId,
                    diagnostico: document.getElementById('diagnostico').value,
                    tratamiento: document.getElementById('tratamiento').value
                };

                fetch('/api/expediente', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: '¡Guardado!',
                            text: 'El expediente se ha actualizado correctamente.',
                            icon: 'success',
                            confirmButtonColor: '#0d6efd',
                            confirmButtonText: 'Aceptar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = 'admin-citas.html';
                            }
                        });
                    } else {
                        Swal.fire('Error', 'No se pudo guardar: ' + data.message, 'error');
                    }
                })
                .catch(err => console.error(err));
            });

            // ELIMINAR (VACIAR)
            document.getElementById('btn-eliminar').addEventListener('click', function() {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "¿Deseas vaciar este expediente? Se borrará el diagnóstico y tratamiento.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33', 
                    cancelButtonColor: '#3085d6', 
                    confirmButtonText: 'Sí, vaciar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/expediente/${usuarioId}`, { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('¡Vaciado!', 'El expediente ha sido limpiado.', 'success')
                                .then(() => {
                                    window.location.href = 'admin-citas.html';
                                });
                            } else {
                                Swal.fire('Error', data.message, 'error');
                            }
                        });
                    }
                });
            });

            // PDF
            document.getElementById('btn-descargar-pdf').addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const hoja = document.getElementById('form-expediente');
                html2canvas(hoja, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    pdf.addImage(imgData, 'PNG', imgX, 10, imgWidth * ratio, imgHeight * ratio);
                    pdf.save(`Expediente-${document.getElementById('nombre').value}.pdf`);
                });
            });
        });
    </script>
</body>
</html>